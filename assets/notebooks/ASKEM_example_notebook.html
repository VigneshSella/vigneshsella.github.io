<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>4a4297d59f3b4f659f55932c7c85d35f</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<section
id="pyciemss-optimize-interface-with-different-intervention-types"
class="cell markdown">
<h1>PyCIEMSS optimize interface with different intervention types</h1>
</section>
<section id="load-dependencies-and-interfaces" class="cell markdown">
<h3>Load dependencies and interfaces</h3>
</section>
<div class="cell code" data-execution_count="7">
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Dict, List</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyro</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyciemss</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyciemss.visuals.plots <span class="im">as</span> plots</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyciemss.integration_utils.intervention_builder <span class="im">import</span> (</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    combine_static_parameter_interventions,</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    param_value_objective,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    start_time_objective,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    start_time_param_value_objective,</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    intervention_func_combinator,</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyciemss.ouu.qoi <span class="im">import</span> obs_max_qoi, obs_nday_average_qoi</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> copy <span class="im">import</span> deepcopy</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>smoke_test <span class="op">=</span> <span class="st">&quot;CI&quot;</span> <span class="kw">in</span> os.environ</span></code></pre></div>
</div>
<section id="select-model" class="cell markdown">
<h3>Select model</h3>
</section>
<div class="cell code" data-execution_count="8">
<div class="sourceCode" id="cb2"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>MODEL_PATH <span class="op">=</span> <span class="st">&quot;https://raw.githubusercontent.com/DARPA-ASKEM/simulation-integration/main/data/models/&quot;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>model_opt1 <span class="op">=</span> os.path.join(MODEL_PATH, <span class="st">&quot;SIR_stockflow.json&quot;</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>model_opt2 <span class="op">=</span> os.path.join(MODEL_PATH, <span class="st">&quot;SEIRHD_NPI_Type1_petrinet.json&quot;</span>)</span></code></pre></div>
</div>
<section id="set-parameters-for-sampling" class="cell markdown">
<h3>Set parameters for sampling</h3>
</section>
<div class="cell code" data-execution_count="9">
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>start_time <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>end_time_SIR <span class="op">=</span> <span class="fl">40.0</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>end_time_SEIRHD <span class="op">=</span> <span class="fl">60.0</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>end_time_SEIRHD2 <span class="op">=</span> <span class="fl">90.0</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>logging_step_size <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>num_samples <span class="op">=</span> <span class="dv">3</span> <span class="cf">if</span> smoke_test <span class="cf">else</span> <span class="dv">1000</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>num_samples_ouu <span class="op">=</span> <span class="dv">10</span> <span class="cf">if</span> smoke_test <span class="cf">else</span> <span class="dv">1000</span> <span class="co"># controls accuracy of risk estimation in each optimization iteration</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>maxiter <span class="op">=</span> <span class="dv">0</span> <span class="cf">if</span> smoke_test <span class="cf">else</span> <span class="dv">3</span>    <span class="co"># maximum number of restarts of local convex optimizer leading to maxiter+1 local optimizations</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>maxfeval <span class="op">=</span> <span class="dv">1</span> <span class="cf">if</span> smoke_test <span class="cf">else</span> <span class="dv">30</span>  <span class="co"># maximum number of function evaluations in each instance of local convex optimization</span></span></code></pre></div>
</div>
<section id="baseline-samples-before-optimization-from-model-1-sir"
class="cell markdown">
<h3>Baseline samples before optimization from model 1 (SIR)</h3>
</section>
<div class="cell code" data-execution_count="10">
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>start_t <span class="op">=</span> time.time()</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>sample_results1 <span class="op">=</span> pyciemss.sample(</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    model_opt1,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    end_time_SIR,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    logging_step_size,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    num_samples,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    start_time<span class="op">=</span>start_time,</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    solver_method<span class="op">=</span><span class="st">&quot;rk4&quot;</span>,</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    solver_options<span class="op">=</span>{<span class="st">&quot;step_size&quot;</span>: <span class="fl">1.</span>},</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Time taken: &quot;</span>, time.time()<span class="op">-</span>start_t)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Risk associated with QoI:&quot;</span>, sample_results1[<span class="st">&quot;risk&quot;</span>][<span class="st">&quot;I_state&quot;</span>][<span class="st">&quot;risk&quot;</span>])</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot results for all states</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>schema <span class="op">=</span> plots.trajectories(sample_results1[<span class="st">&quot;data&quot;</span>], keep<span class="op">=</span><span class="st">&quot;.*_state&quot;</span>, qlow<span class="op">=</span><span class="fl">0.0</span>, qhigh<span class="op">=</span><span class="fl">1.0</span>)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>plots.ipy_display(schema, dpi<span class="op">=</span><span class="dv">150</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Time taken:  2.329202890396118
Risk associated with QoI: [480.3737524414062]
</code></pre>
</div>
<div class="output execute_result" data-execution_count="10">
<p><img
src="vertopal_ed73d86613e540ab84c49649ae65c317/9f9c13fa49f40e81fa4d7596882d9921ac3ada41.png" /></p>
</div>
</div>
<section id="baseline-samples-before-optimization-from-model-2-seirhd"
class="cell markdown">
<h3>Baseline samples before optimization from model 2 (SEIRHD)</h3>
</section>
<div class="cell code" data-execution_count="11">
<div class="sourceCode" id="cb6"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>start_t <span class="op">=</span> time.time()</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>sample_results2 <span class="op">=</span> pyciemss.sample(</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    model_opt2,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    end_time_SEIRHD,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    logging_step_size,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    num_samples,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    start_time<span class="op">=</span>start_time,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># solver_method=&quot;dopri5&quot;,</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    solver_method<span class="op">=</span><span class="st">&quot;rk4&quot;</span>,</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    solver_options<span class="op">=</span>{<span class="st">&quot;step_size&quot;</span>: <span class="fl">1.</span>}</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Time taken: &quot;</span>, time.time()<span class="op">-</span>start_t)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Risk associated with QoI:&quot;</span>, sample_results2[<span class="st">&quot;risk&quot;</span>][<span class="st">&quot;I_state&quot;</span>][<span class="st">&quot;risk&quot;</span>])</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="co"># display(sample_results2[&quot;data&quot;])</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot results for all states</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>schema <span class="op">=</span> plots.trajectories(sample_results2[<span class="st">&quot;data&quot;</span>], keep<span class="op">=</span><span class="st">&quot;.*_state&quot;</span>, qlow<span class="op">=</span><span class="fl">0.0</span>, qhigh<span class="op">=</span><span class="fl">1.0</span>)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>plots.ipy_display(schema, dpi<span class="op">=</span><span class="dv">150</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Time taken:  4.139211416244507
Risk associated with QoI: [4464067.959999998]
</code></pre>
</div>
<div class="output execute_result" data-execution_count="11">
<p><img
src="vertopal_ed73d86613e540ab84c49649ae65c317/51d75039ba77e967230e39ad749bae0ae7b7336e.png" /></p>
</div>
</div>
<section id="optimize-interface-with-single-intervention"
class="cell markdown">
<h2>Optimize interface with single intervention</h2>
<h3 id="optimizing-a-single-parameter-value-sir">Optimizing a single
parameter value (SIR)</h3>
<p>Minimum change in the intervention parameter from the current value
to get infections below 200 individuals at 40 days for SIR model</p>
</section>
<div class="cell code" data-execution_count="12">
<div class="sourceCode" id="cb8"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define optimization problem setup</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>observed_params <span class="op">=</span> [<span class="st">&quot;I_state&quot;</span>]</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>intervention_time <span class="op">=</span> [torch.tensor(<span class="fl">1.0</span>)]</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>intervened_params <span class="op">=</span> [<span class="st">&quot;p_cbeta&quot;</span>]</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>p_cbeta_current <span class="op">=</span> <span class="fl">0.35</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>initial_guess_interventions <span class="op">=</span> <span class="fl">0.15</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>bounds_interventions <span class="op">=</span> [[<span class="fl">0.1</span>], [<span class="fl">0.5</span>]]</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>static_parameter_interventions <span class="op">=</span> param_value_objective(</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    param_name <span class="op">=</span> intervened_params,</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    param_value <span class="op">=</span> [<span class="kw">lambda</span> x: torch.tensor(x)],</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    start_time <span class="op">=</span> intervention_time,</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>risk_bound <span class="op">=</span> <span class="fl">200.0</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>qoi <span class="op">=</span> <span class="kw">lambda</span> y: obs_nday_average_qoi(y, observed_params, <span class="dv">1</span>)</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>objfun <span class="op">=</span> <span class="kw">lambda</span> x: np.<span class="bu">abs</span>(p_cbeta_current <span class="op">-</span> x)</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Run optimize interface</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>opt_result1 <span class="op">=</span> pyciemss.optimize(</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    model_opt1,</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    end_time_SIR,</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    logging_step_size,</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    qoi,</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    risk_bound,</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    static_parameter_interventions,</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    objfun,</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    initial_guess_interventions<span class="op">=</span>initial_guess_interventions,</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>    bounds_interventions<span class="op">=</span>bounds_interventions,</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>    start_time<span class="op">=</span>start_time,</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    n_samples_ouu<span class="op">=</span>num_samples_ouu,</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>    maxiter<span class="op">=</span>maxiter,</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>    maxfeval<span class="op">=</span>maxfeval,</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>    solver_method<span class="op">=</span><span class="st">&quot;rk4&quot;</span>,</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>    solver_options<span class="op">=</span>{<span class="st">&quot;step_size&quot;</span>: <span class="fl">1.</span>},</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&#39;Optimal policy:&#39;</span>, opt_result1[<span class="st">&quot;policy&quot;</span>])</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(opt_result1)</span></code></pre></div>
<div class="output stream stderr">
<pre><code> 52%|█████▏    | 62/120 [01:02&lt;01:23,  1.44s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 54%|█████▍    | 65/120 [01:11&lt;02:10,  2.37s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 56%|█████▌    | 67/120 [01:13&lt;01:35,  1.80s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 60%|██████    | 72/120 [01:20&lt;01:12,  1.51s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 62%|██████▏   | 74/120 [01:21&lt;00:55,  1.22s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 63%|██████▎   | 76/120 [01:21&lt;00:47,  1.07s/it]</code></pre>
</div>
<div class="output stream stdout">
<pre><code>Optimal policy: tensor([0.1940], dtype=torch.float64)
{&#39;policy&#39;: tensor([0.1940], dtype=torch.float64), &#39;OptResults&#39;:                     message: [&#39;requested number of basinhopping iterations completed successfully&#39;]
                    success: True
                        fun: 0.15601673345676997
                          x: [ 1.940e-01]
                        nit: 3
      minimization_failures: 2
                       nfev: 74
 lowest_optimization_result: message: Optimization terminated successfully.
                             success: True
                              status: 1
                                 fun: 0.15601673345676997
                                   x: [ 1.940e-01]
                                nfev: 7
                               maxcv: 0.0}
</code></pre>
</div>
<div class="output stream stderr">
<pre><code>
</code></pre>
</div>
</div>
<section id="sample-using-optimal-policy-as-intervention"
class="cell markdown">
<h4>Sample using optimal policy as intervention</h4>
</section>
<div class="cell code" data-execution_count="13">
<div class="sourceCode" id="cb12"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Intervention: &quot;</span>, static_parameter_interventions(opt_result1[<span class="st">&quot;policy&quot;</span>]))</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>result1 <span class="op">=</span> pyciemss.sample(</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    model_opt1,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    end_time_SIR,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    logging_step_size,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    num_samples,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    start_time<span class="op">=</span>start_time,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    static_parameter_interventions<span class="op">=</span>static_parameter_interventions(opt_result1[<span class="st">&quot;policy&quot;</span>]),</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    solver_method<span class="op">=</span><span class="st">&quot;rk4&quot;</span>,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    solver_options<span class="op">=</span>{<span class="st">&quot;step_size&quot;</span>: <span class="fl">1.</span>},</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co"># display(result1[&quot;data&quot;])</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Risk associated with QoI:&quot;</span>, result1[<span class="st">&quot;risk&quot;</span>][observed_params[<span class="dv">0</span>]][<span class="st">&quot;risk&quot;</span>])</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot results for all states</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>schema <span class="op">=</span> plots.trajectories(result1[<span class="st">&quot;data&quot;</span>], keep<span class="op">=</span><span class="st">&quot;.*_state&quot;</span>, qlow<span class="op">=</span><span class="fl">0.0</span>, qhigh<span class="op">=</span><span class="fl">1.0</span>)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>plots.ipy_display(schema, dpi<span class="op">=</span><span class="dv">150</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Intervention:  {1.0: {&#39;p_cbeta&#39;: tensor([0.1940])}}
</code></pre>
</div>
<div class="output stream stdout">
<pre><code>Risk associated with QoI: [217.07194946289061]
</code></pre>
</div>
<div class="output execute_result" data-execution_count="13">
<p><img
src="vertopal_ed73d86613e540ab84c49649ae65c317/f86419d68e099985be73c79f73f39fcf8dacd198.png" /></p>
</div>
</div>
<section id="optimizing-the-start-time-for-a-single-intervention-sir"
class="cell markdown">
<h3>Optimizing the start time for a single intervention (SIR)</h3>
<p>Maximum delay in the intervention to get infections below 200
individuals at 40 days for SIR model</p>
</section>
<div class="cell code" data-execution_count="14">
<div class="sourceCode" id="cb15"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define optimization problem setup</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>observed_params <span class="op">=</span> [<span class="st">&quot;I_state&quot;</span>]</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>intervened_params <span class="op">=</span> [<span class="st">&quot;p_cbeta&quot;</span>]</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>initial_guess_interventions <span class="op">=</span> <span class="fl">5.</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>bounds_interventions <span class="op">=</span> [[<span class="fl">1.</span>], [<span class="fl">39.</span>]]    <span class="co"># bounds should be withing start_time and end_time</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>intervention_value <span class="op">=</span> torch.tensor([<span class="fl">0.15</span>])</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>static_parameter_interventions <span class="op">=</span> start_time_objective(</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    param_name <span class="op">=</span> intervened_params,</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    param_value <span class="op">=</span> intervention_value,</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>risk_bound <span class="op">=</span> <span class="fl">200.0</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>qoi <span class="op">=</span> <span class="kw">lambda</span> y: obs_nday_average_qoi(y, observed_params, <span class="dv">1</span>)</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>objfun <span class="op">=</span> <span class="kw">lambda</span> x: <span class="op">-</span>x</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Run optimize interface</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>opt_result2 <span class="op">=</span> pyciemss.optimize(</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    model_opt1,</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    end_time_SIR,</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    logging_step_size,</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>    qoi,</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    risk_bound,</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    static_parameter_interventions,</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    objfun,</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>    initial_guess_interventions<span class="op">=</span>initial_guess_interventions,</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>    bounds_interventions<span class="op">=</span>bounds_interventions,</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>    start_time<span class="op">=</span>start_time,</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    n_samples_ouu<span class="op">=</span>num_samples_ouu,</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>    maxiter<span class="op">=</span>maxiter,</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>    maxfeval<span class="op">=</span>maxfeval,</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>    solver_method<span class="op">=</span><span class="st">&quot;rk4&quot;</span>,</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>    solver_options<span class="op">=</span>{<span class="st">&quot;step_size&quot;</span>: <span class="fl">1.</span>},</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&#39;Optimal policy:&#39;</span>, opt_result2[<span class="st">&quot;policy&quot;</span>])</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(opt_result2)</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Intervention: &quot;</span>, static_parameter_interventions(opt_result2[<span class="st">&quot;policy&quot;</span>]))</span></code></pre></div>
<div class="output stream stderr">
<pre><code> 36%|███▌      | 43/120 [00:48&lt;01:26,  1.13s/it]</code></pre>
</div>
<div class="output stream stdout">
<pre><code>Optimal policy: tensor([7.6958], dtype=torch.float64)
{&#39;policy&#39;: tensor([7.6958], dtype=torch.float64), &#39;OptResults&#39;:                     message: [&#39;requested number of basinhopping iterations completed successfully&#39;]
                    success: True
                        fun: -7.69576122033028
                          x: [ 7.696e+00]
                        nit: 3
      minimization_failures: 0
                       nfev: 43
 lowest_optimization_result: message: Optimization terminated successfully.
                             success: True
                              status: 1
                                 fun: -7.69576122033028
                                   x: [ 7.696e+00]
                                nfev: 10
                               maxcv: 9.765624980673238e-06}
Intervention:  {7.6958: {&#39;p_cbeta&#39;: tensor([0.1500])}}
</code></pre>
</div>
<div class="output stream stderr">
<pre><code>
</code></pre>
</div>
</div>
<div class="cell code" data-execution_count="15">
<div class="sourceCode" id="cb19"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>result2 <span class="op">=</span> pyciemss.sample(</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    model_opt1,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    end_time_SIR,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    logging_step_size,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    num_samples,</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    start_time<span class="op">=</span>start_time,</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    static_parameter_interventions<span class="op">=</span>static_parameter_interventions(opt_result2[<span class="st">&quot;policy&quot;</span>]),</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    solver_method<span class="op">=</span><span class="st">&quot;euler&quot;</span>,</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    solver_options<span class="op">=</span>{<span class="st">&quot;step_size&quot;</span>: <span class="fl">1.</span>},</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co"># display(result2[&quot;data&quot;])</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Check risk estimate used in constraints</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Risk associated with QoI:&quot;</span>, result2[<span class="st">&quot;risk&quot;</span>][observed_params[<span class="dv">0</span>]][<span class="st">&quot;risk&quot;</span>])</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot results for all states</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>schema <span class="op">=</span> plots.trajectories(result2[<span class="st">&quot;data&quot;</span>], keep<span class="op">=</span><span class="st">&quot;.*_state&quot;</span>, qlow<span class="op">=</span><span class="fl">0.0</span>, qhigh<span class="op">=</span><span class="fl">1.0</span>)</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>plots.ipy_display(schema, dpi<span class="op">=</span><span class="dv">150</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Risk associated with QoI: [154.71628662109373]
</code></pre>
</div>
<div class="output execute_result" data-execution_count="15">
<p><img
src="vertopal_ed73d86613e540ab84c49649ae65c317/7d5fbe787891d10d887312b3816ba65d9070152d.png" /></p>
</div>
</div>
<section id="optimize-interface-with-multiple-interventions"
class="cell markdown">
<h2>Optimize interface with multiple interventions</h2>
<h3 id="optimizing-multiple-intervention-values-seirhd">Optimizing
multiple intervention values (SEIRHD)</h3>
<p>Minimum change in two intervention parameters from their current
values to get infections below 30000 individuals at 60 days for SEIRHD
model</p>
<ul>
<li>Intervene on beta_c after 10 days</li>
<li>Intervene on gamma after 15 days</li>
</ul>
</section>
<div class="cell code" data-execution_count="16">
<div class="sourceCode" id="cb21"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define optimization problem setup</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>observed_params <span class="op">=</span> [<span class="st">&quot;I_state&quot;</span>]</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>intervention_time <span class="op">=</span> [torch.tensor(<span class="fl">10.0</span>), torch.tensor(<span class="fl">15.0</span>)]</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>intervened_params <span class="op">=</span> [<span class="st">&quot;beta_c&quot;</span>, <span class="st">&quot;gamma&quot;</span>]</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>param_current <span class="op">=</span> [<span class="fl">0.35</span>, <span class="fl">0.2</span>]</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>initial_guess_interventions <span class="op">=</span> [<span class="fl">0.2</span>, <span class="fl">0.4</span>]</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>bounds_interventions <span class="op">=</span> [[<span class="fl">0.1</span>, <span class="fl">0.1</span>], [<span class="fl">0.5</span>, <span class="fl">0.5</span>]]</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Note that param_value is not passed in below and defaults to None.</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="co"># User can also pass ina list of lambda x: torch.tensor(x) for each intervention.</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>static_parameter_interventions <span class="op">=</span> param_value_objective(</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    param_name<span class="op">=</span>intervened_params,</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    start_time<span class="op">=</span>intervention_time,</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>risk_bound <span class="op">=</span> <span class="fl">3e4</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>qoi <span class="op">=</span> <span class="kw">lambda</span> y: obs_nday_average_qoi(y, observed_params, <span class="dv">1</span>)</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>objfun <span class="op">=</span> <span class="kw">lambda</span> x: np.<span class="bu">sum</span>(np.<span class="bu">abs</span>(param_current <span class="op">-</span> x))</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Run optimize interface</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>opt_result3 <span class="op">=</span> pyciemss.optimize(</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    model_opt2,</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    end_time_SEIRHD,</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    logging_step_size,</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>    qoi,</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>    risk_bound,</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>    static_parameter_interventions,</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>    objfun,</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>    initial_guess_interventions<span class="op">=</span>initial_guess_interventions,</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>    bounds_interventions<span class="op">=</span>bounds_interventions,</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>    start_time<span class="op">=</span>start_time,</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>    n_samples_ouu<span class="op">=</span>num_samples_ouu,</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>    maxiter<span class="op">=</span>maxiter,</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>    maxfeval<span class="op">=</span>maxfeval,</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>    solver_method<span class="op">=</span><span class="st">&quot;rk4&quot;</span>,</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>    solver_options<span class="op">=</span>{<span class="st">&quot;step_size&quot;</span>: <span class="fl">1.</span>},</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Optimal policy:&quot;</span>, opt_result3[<span class="st">&quot;policy&quot;</span>])</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(opt_result3)</span></code></pre></div>
<div class="output stream stderr">
<pre><code> 53%|█████▎    | 64/120 [03:57&lt;02:44,  2.94s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 79%|███████▉  | 95/120 [05:28&lt;01:30,  3.63s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
124it [06:50,  3.31s/it]                         </code></pre>
</div>
<div class="output stream stdout">
<pre><code>Optimal policy: tensor([0.3500, 0.4495], dtype=torch.float64)
{&#39;policy&#39;: tensor([0.3500, 0.4495], dtype=torch.float64), &#39;OptResults&#39;:                     message: [&#39;requested number of basinhopping iterations completed successfully&#39;]
                    success: False
                        fun: 0.2494535138541334
                          x: [ 3.500e-01  4.495e-01]
                        nit: 3
      minimization_failures: 4
                       nfev: 120
 lowest_optimization_result: message: Maximum number of function evaluations has been exceeded.
                             success: False
                              status: 2
                                 fun: 0.2494535138541334
                                   x: [ 3.500e-01  4.494e-01]
                                nfev: 30
                               maxcv: 0.0}
</code></pre>
</div>
<div class="output stream stderr">
<pre><code>
</code></pre>
</div>
</div>
<section id="sample-using-optimal-policy-as-intervention"
class="cell markdown">
<h4>Sample using optimal policy as intervention</h4>
</section>
<div class="cell code" data-execution_count="17">
<div class="sourceCode" id="cb25"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Intervention: &quot;</span>, static_parameter_interventions(opt_result3[<span class="st">&quot;policy&quot;</span>]))</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pyro.poutine.seed(rng_seed<span class="op">=</span><span class="dv">0</span>):</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    result3 <span class="op">=</span> pyciemss.sample(</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>        model_opt2,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>        end_time_SEIRHD,</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>        logging_step_size,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>        num_samples,</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>        start_time<span class="op">=</span>start_time,</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>        static_parameter_interventions<span class="op">=</span>static_parameter_interventions(opt_result3[<span class="st">&quot;policy&quot;</span>]),</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>        solver_method<span class="op">=</span><span class="st">&quot;rk4&quot;</span>,</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>        solver_options<span class="op">=</span>{<span class="st">&quot;step_size&quot;</span>: <span class="fl">1.</span>},</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Check risk estimate used in constraints</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Risk associated with QoI:&quot;</span>, result3[<span class="st">&quot;risk&quot;</span>][observed_params[<span class="dv">0</span>]][<span class="st">&quot;risk&quot;</span>])</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot results for all states</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>schema <span class="op">=</span> plots.trajectories(result3[<span class="st">&quot;data&quot;</span>], keep<span class="op">=</span><span class="st">&quot;I_state&quot;</span>, qlow<span class="op">=</span><span class="fl">0.0</span>, qhigh<span class="op">=</span><span class="fl">1.0</span>)</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>plots.ipy_display(schema, dpi<span class="op">=</span><span class="dv">150</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Intervention:  {10.0: {&#39;beta_c&#39;: tensor([0.3500])}, 15.0: {&#39;gamma&#39;: tensor([0.4495])}}
Risk associated with QoI: [33007.13003906248]
</code></pre>
</div>
<div class="output execute_result" data-execution_count="17">
<p><img
src="vertopal_ed73d86613e540ab84c49649ae65c317/09c1d3ca0cc493e4990852a2fb632af68e69e1fb.png" /></p>
</div>
</div>
<section
id="optimizing-for-start-times-of-multiple-interventions-seirhd"
class="cell markdown">
<h3>Optimizing for start times of multiple interventions (SEIRHD)</h3>
<p>Maximum delay in starting two interventions to get infections below
30000 individuals at 60 days for SEIRHD model</p>
<ul>
<li>Intervene on beta_c to be 0.15</li>
<li>Intervene on gamma to be 0.4</li>
</ul>
</section>
<div class="cell code" data-execution_count="18">
<div class="sourceCode" id="cb27"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define optimization problem setup</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>observed_params <span class="op">=</span> [<span class="st">&quot;I_state&quot;</span>]</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>intervened_params <span class="op">=</span> [<span class="st">&quot;beta_c&quot;</span>, <span class="st">&quot;gamma&quot;</span>]</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>initial_guess_interventions <span class="op">=</span> [torch.tensor(<span class="fl">10.</span>), torch.tensor(<span class="fl">10.</span>)]</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>bounds_interventions <span class="op">=</span> [[<span class="fl">1.</span>, <span class="fl">1.</span>], [<span class="fl">39.</span>, <span class="fl">39.</span>]]    <span class="co"># bounds should be withing start_time and end_time</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>intervention_value <span class="op">=</span> torch.tensor([<span class="fl">0.15</span>, <span class="fl">0.4</span>])</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>static_parameter_interventions <span class="op">=</span> start_time_objective(</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    param_name <span class="op">=</span> intervened_params,</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    param_value <span class="op">=</span> intervention_value,</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>risk_bound <span class="op">=</span> [<span class="fl">3e4</span>]</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>qoi <span class="op">=</span> [<span class="kw">lambda</span> y: obs_nday_average_qoi(y, observed_params, <span class="dv">1</span>)]</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>objfun <span class="op">=</span> <span class="kw">lambda</span> x: <span class="op">-</span>np.<span class="bu">sum</span>(np.<span class="bu">abs</span>(x))</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Run optimize interface</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>opt_result4 <span class="op">=</span> pyciemss.optimize(</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>    model_opt2,</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>    end_time_SEIRHD,</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>    logging_step_size,</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>    qoi,</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>    risk_bound,</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>    static_parameter_interventions,</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>    objfun,</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>    initial_guess_interventions<span class="op">=</span>initial_guess_interventions,</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>    bounds_interventions<span class="op">=</span>bounds_interventions,</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>    start_time<span class="op">=</span>start_time,</span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>    n_samples_ouu<span class="op">=</span>num_samples_ouu,</span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>    maxiter<span class="op">=</span>maxiter,</span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>    maxfeval<span class="op">=</span>maxfeval,</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>    solver_method<span class="op">=</span><span class="st">&quot;rk4&quot;</span>,</span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>    solver_options<span class="op">=</span>{<span class="st">&quot;step_size&quot;</span>: <span class="fl">1.</span>},</span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&#39;Optimal policy:&#39;</span>, opt_result4[<span class="st">&quot;policy&quot;</span>])</span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(opt_result4)</span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Intervention: &quot;</span>, static_parameter_interventions(opt_result4[<span class="st">&quot;policy&quot;</span>]))</span></code></pre></div>
<div class="output stream stderr">
<pre><code>  8%|▊         | 9/120 [00:27&lt;05:11,  2.81s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 10%|█         | 12/120 [00:32&lt;04:09,  2.31s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 12%|█▎        | 15/120 [00:38&lt;03:41,  2.11s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 14%|█▍        | 17/120 [00:40&lt;03:08,  1.83s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 17%|█▋        | 20/120 [00:47&lt;03:17,  1.98s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 19%|█▉        | 23/120 [00:52&lt;03:10,  1.96s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 21%|██        | 25/120 [00:55&lt;02:47,  1.76s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 23%|██▎       | 28/120 [01:01&lt;02:53,  1.88s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 27%|██▋       | 32/120 [01:09&lt;03:02,  2.07s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 29%|██▉       | 35/120 [01:14&lt;02:50,  2.01s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 33%|███▎      | 40/120 [01:28&lt;03:39,  2.74s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 35%|███▌      | 42/120 [01:31&lt;02:51,  2.20s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 37%|███▋      | 44/120 [01:34&lt;02:26,  1.93s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 39%|███▉      | 47/120 [01:39&lt;02:25,  1.99s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 41%|████      | 49/120 [01:42&lt;02:06,  1.78s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 42%|████▎     | 51/120 [01:45&lt;01:53,  1.65s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 45%|████▌     | 54/120 [01:51&lt;02:06,  1.92s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 48%|████▊     | 57/120 [01:57&lt;02:02,  1.94s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 49%|████▉     | 59/120 [02:00&lt;01:51,  1.83s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 54%|█████▍    | 65/120 [02:17&lt;02:29,  2.72s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 56%|█████▌    | 67/120 [02:20&lt;01:59,  2.25s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 60%|██████    | 72/120 [02:31&lt;01:55,  2.40s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 62%|██████▏   | 74/120 [02:34&lt;01:33,  2.04s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 63%|██████▎   | 76/120 [02:37&lt;01:20,  1.82s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 65%|██████▌   | 78/120 [02:40&lt;01:11,  1.71s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 67%|██████▋   | 80/120 [02:43&lt;01:04,  1.61s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 68%|██████▊   | 82/120 [02:45&lt;00:59,  1.55s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 71%|███████   | 85/120 [02:51&lt;01:01,  1.75s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 72%|███████▎  | 87/120 [02:54&lt;00:53,  1.62s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 74%|███████▍  | 89/120 [02:57&lt;00:48,  1.56s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 76%|███████▌  | 91/120 [03:00&lt;00:43,  1.51s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 81%|████████  | 97/120 [03:13&lt;00:49,  2.17s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 82%|████████▎ | 99/120 [03:16&lt;00:39,  1.89s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 84%|████████▍ | 101/120 [03:19&lt;00:32,  1.73s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 87%|████████▋ | 104/120 [03:25&lt;00:29,  1.87s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 88%|████████▊ | 106/120 [03:28&lt;00:24,  1.72s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 90%|█████████ | 108/120 [03:31&lt;00:19,  1.63s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 92%|█████████▎| 111/120 [03:37&lt;00:17,  1.94s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 94%|█████████▍| 113/120 [03:41&lt;00:13,  1.95s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 96%|█████████▌| 115/120 [03:44&lt;00:08,  1.80s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 98%|█████████▊| 117/120 [03:47&lt;00:04,  1.66s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 99%|█████████▉| 119/120 [03:49&lt;00:01,  1.59s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
121it [03:52,  1.53s/it]                         C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
124it [03:55,  1.90s/it]</code></pre>
</div>
<div class="output stream stdout">
<pre><code>Optimal policy: tensor([39.0000,  6.0327], dtype=torch.float64)
{&#39;policy&#39;: tensor([39.0000,  6.0327], dtype=torch.float64), &#39;OptResults&#39;:                     message: [&#39;requested number of basinhopping iterations completed successfully&#39;]
                    success: False
                        fun: -45.032607877335636
                          x: [ 3.900e+01  6.033e+00]
                        nit: 3
      minimization_failures: 4
                       nfev: 120
 lowest_optimization_result: message: Did not converge to a solution satisfying the constraints. See `maxcv` for magnitude of violation.
                             success: False
                              status: 4
                                 fun: -45.032607877335636
                                   x: [ 3.900e+01  6.033e+00]
                                nfev: 30
                               maxcv: 0.006562499991559889}
Intervention:  {39.0: {&#39;beta_c&#39;: tensor([0.1500])}, 6.0327: {&#39;gamma&#39;: tensor([0.4000])}}
</code></pre>
</div>
<div class="output stream stderr">
<pre><code>
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\interfaces.py:978: UserWarning: Optimal intervention policy does not satisfy constraints.Check if the risk_bounds value is appropriate for given problem.Otherwise, try (i) different initial_guess_interventions, (ii) increasing maxiter/maxfeval,and/or (iii) increase n_samples_ouu to improve accuracy of Monte Carlo risk estimation. 
  warnings.warn(
</code></pre>
</div>
</div>
<div class="cell code" data-execution_count="19">
<div class="sourceCode" id="cb31"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Intervention: &quot;</span>, static_parameter_interventions(opt_result4[<span class="st">&quot;policy&quot;</span>]))</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>start_t <span class="op">=</span> time.time()</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pyro.poutine.seed(rng_seed<span class="op">=</span><span class="dv">0</span>):</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    result4 <span class="op">=</span> pyciemss.sample(</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>        model_opt2,</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>        end_time_SEIRHD,</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>        logging_step_size,</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>        num_samples,</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>        start_time<span class="op">=</span>start_time,</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>        static_parameter_interventions<span class="op">=</span>static_parameter_interventions(opt_result4[<span class="st">&quot;policy&quot;</span>]),</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>        solver_method<span class="op">=</span><span class="st">&quot;rk4&quot;</span>,</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># solver_method=&quot;euler&quot;,</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>        solver_options<span class="op">=</span>{<span class="st">&quot;step_size&quot;</span>:<span class="fl">1.</span>},</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Time taken: &quot;</span>, time.time()<span class="op">-</span>start_t)</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Check risk estimate used in constraints</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Risk associated with QoI:&quot;</span>, result4[<span class="st">&quot;risk&quot;</span>][observed_params[<span class="dv">0</span>]][<span class="st">&quot;risk&quot;</span>])</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot results for all states</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>schema <span class="op">=</span> plots.trajectories(result4[<span class="st">&quot;data&quot;</span>], keep<span class="op">=</span><span class="st">&quot;I_state&quot;</span>, qlow<span class="op">=</span><span class="fl">0.0</span>, qhigh<span class="op">=</span><span class="fl">1.0</span>)</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>plots.ipy_display(schema, dpi<span class="op">=</span><span class="dv">150</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Intervention:  {39.0: {&#39;beta_c&#39;: tensor([0.1500])}, 6.0327: {&#39;gamma&#39;: tensor([0.4000])}}
Time taken:  10.36467456817627
Risk associated with QoI: [33810.86929687499]
</code></pre>
</div>
<div class="output execute_result" data-execution_count="19">
<p><img
src="vertopal_ed73d86613e540ab84c49649ae65c317/f2ed5552090b17859d61fb823b772d411a80d79c.png" /></p>
</div>
</div>
<section
id="optimize-interface-with-multiple-interventions-and-qoi-defined-as-max-over-range-of-simulated-time"
class="cell markdown">
<h2>Optimize interface with multiple interventions and QoI defined as
max over range of simulated time</h2>
<h3
id="optimizing-multiple-intervention-values-seirhd-with-existing-intervention-on-hosp-parameter">Optimizing
multiple intervention values (SEIRHD) with existing intervention on hosp
parameter</h3>
<p>Minimum change in two intervention parameters from their current
values to get infections below 300,000 individuals betweeen 0-90 days
for SEIRHD model</p>
<ul>
<li>Intervene on beta_c after 10 days</li>
<li>Intervene on gamma after 15 days</li>
</ul>
<p>Intervention on "hosp" parameter is set to 0.1 after 10 days</p>
</section>
<div class="cell code" data-execution_count="20">
<div class="sourceCode" id="cb33"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define optimization problem setup</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>observed_params <span class="op">=</span> [<span class="st">&quot;I_state&quot;</span>]</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>intervention_time <span class="op">=</span> [torch.tensor(<span class="fl">10.0</span>), torch.tensor(<span class="fl">15.0</span>)]</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>intervened_params <span class="op">=</span> [<span class="st">&quot;beta_c&quot;</span>, <span class="st">&quot;gamma&quot;</span>]</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>param_current <span class="op">=</span> [<span class="fl">0.35</span>, <span class="fl">0.2</span>]</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>initial_guess_interventions <span class="op">=</span> [<span class="fl">0.2</span>, <span class="fl">0.4</span>]</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>bounds_interventions <span class="op">=</span> [[<span class="fl">0.1</span>, <span class="fl">0.1</span>], [<span class="fl">0.5</span>, <span class="fl">0.5</span>]]</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Note that param_value is not passed in below and defaults to None.</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="co"># User can also pass in a list of lambda x: torch.tensor(x) for each intervention.</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>static_parameter_interventions <span class="op">=</span> param_value_objective(</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>    param_name<span class="op">=</span>intervened_params,</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>    start_time<span class="op">=</span>intervention_time,</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>risk_bound <span class="op">=</span> <span class="fl">3e5</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>qoi <span class="op">=</span> <span class="kw">lambda</span> y: obs_max_qoi(y, observed_params)</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>objfun <span class="op">=</span> <span class="kw">lambda</span> x: np.<span class="bu">sum</span>(np.<span class="bu">abs</span>(param_current <span class="op">-</span> x))</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>fixed_interventions <span class="op">=</span> {<span class="fl">10.</span>: {<span class="st">&quot;hosp&quot;</span>: torch.tensor(<span class="fl">0.1</span>)}}</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Run optimize interface</span></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>opt_result5 <span class="op">=</span> pyciemss.optimize(</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>    model_opt2,</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>    end_time_SEIRHD2,</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>    logging_step_size,</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>    qoi,</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>    risk_bound,</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>    static_parameter_interventions,</span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>    objfun,</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>    initial_guess_interventions<span class="op">=</span>initial_guess_interventions,</span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>    bounds_interventions<span class="op">=</span>bounds_interventions,</span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>    start_time<span class="op">=</span>start_time,</span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>    n_samples_ouu<span class="op">=</span>num_samples_ouu,</span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a>    maxiter<span class="op">=</span>maxiter,</span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a>    maxfeval<span class="op">=</span>maxfeval,</span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a>    fixed_static_parameter_interventions<span class="op">=</span>fixed_interventions,</span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a>    solver_method<span class="op">=</span><span class="st">&quot;rk4&quot;</span>,</span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>    solver_options<span class="op">=</span>{<span class="st">&quot;step_size&quot;</span>: <span class="fl">1.0</span>},</span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Optimal policy:&quot;</span>, opt_result5[<span class="st">&quot;policy&quot;</span>])</span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(opt_result5)</span></code></pre></div>
<div class="output stream stderr">
<pre><code> 28%|██▊       | 33/120 [02:39&lt;06:09,  4.25s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 52%|█████▎    | 63/120 [04:37&lt;04:14,  4.46s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 79%|███████▉  | 95/120 [06:38&lt;01:46,  4.25s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
124it [08:25,  4.08s/it]                         </code></pre>
</div>
<div class="output stream stdout">
<pre><code>Optimal policy: tensor([0.3500, 0.4602], dtype=torch.float64)
{&#39;policy&#39;: tensor([0.3500, 0.4602], dtype=torch.float64), &#39;OptResults&#39;:                     message: [&#39;requested number of basinhopping iterations completed successfully&#39;]
                    success: False
                        fun: 0.26016707274061507
                          x: [ 3.500e-01  4.602e-01]
                        nit: 3
      minimization_failures: 4
                       nfev: 120
 lowest_optimization_result: message: Maximum number of function evaluations has been exceeded.
                             success: False
                              status: 2
                                 fun: 0.26016707274061507
                                   x: [ 3.500e-01  4.601e-01]
                                nfev: 30
                               maxcv: 0.0}
</code></pre>
</div>
<div class="output stream stderr">
<pre><code>
</code></pre>
</div>
</div>
<section id="sample-using-optimal-policy-as-intervention"
class="cell markdown">
<h4>Sample using optimal policy as intervention</h4>
</section>
<div class="cell code" data-execution_count="21">
<div class="sourceCode" id="cb37"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Fixed interventions: &quot;</span>, fixed_interventions)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>opt_intervention <span class="op">=</span> combine_static_parameter_interventions([deepcopy(fixed_interventions), static_parameter_interventions(opt_result5[<span class="st">&quot;policy&quot;</span>])])</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Optimal intervention (including fixed interventions): &quot;</span>, opt_intervention)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pyro.poutine.seed(rng_seed<span class="op">=</span><span class="dv">0</span>):</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    result5 <span class="op">=</span> pyciemss.sample(</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>        model_opt2,</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>        end_time_SEIRHD2,</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>        logging_step_size,</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>        num_samples,</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>        start_time<span class="op">=</span>start_time,</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>        static_parameter_interventions<span class="op">=</span>opt_intervention,</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>        solver_method<span class="op">=</span><span class="st">&quot;rk4&quot;</span>,</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>        solver_options<span class="op">=</span>{<span class="st">&quot;step_size&quot;</span>: <span class="fl">1.</span>},</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Check risk estimate used in constraints</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Risk associated with QoI:&quot;</span>, result5[<span class="st">&quot;risk&quot;</span>][observed_params[<span class="dv">0</span>]][<span class="st">&quot;risk&quot;</span>])</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot results for all states</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>schema <span class="op">=</span> plots.trajectories(result5[<span class="st">&quot;data&quot;</span>], keep<span class="op">=</span><span class="st">&quot;I_state&quot;</span>, qlow<span class="op">=</span><span class="fl">0.0</span>, qhigh<span class="op">=</span><span class="fl">1.0</span>)</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>plots.ipy_display(schema, dpi<span class="op">=</span><span class="dv">150</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Fixed interventions:  {10.0: {&#39;hosp&#39;: tensor(0.1000)}}
Optimal intervention (including fixed interventions):  {10.0: {&#39;hosp&#39;: tensor(0.1000), &#39;beta_c&#39;: tensor([0.3500])}, 15.0: {&#39;gamma&#39;: tensor([0.4602])}}
Risk associated with QoI: [306010.22749999986]
</code></pre>
</div>
<div class="output execute_result" data-execution_count="21">
<p><img
src="vertopal_ed73d86613e540ab84c49649ae65c317/56f4b960168e370543bb8c617e6f232fad28b2d3.png" /></p>
</div>
</div>
<section id="optimize-interface-with-multiple-intervention-templates"
class="cell markdown">
<h2>Optimize interface with multiple intervention templates</h2>
<h3
id="optimizing-multiple-intervention-values-andor-start-times-with-existing-intervention-on-hosp-parameter-seirhd">Optimizing
multiple intervention values and/or start times with existing
intervention on hosp parameter (SEIRHD)</h3>
<p>Get infections below 300,000 individuals betweeen 0-90 days for
SEIRHD model</p>
<ul>
<li>Minimum change from their current value when intervening on beta_c
after 10 days</li>
<li>Maximum delay in starting the interventions on gamma with
intervention value set to 0.35</li>
</ul>
<p>Intervention on "hosp" parameter is set to 0.1 after 10 days.</p>
<p>QoI defined as max over range of simulated time.</p>
</section>
<div class="cell code" data-execution_count="22">
<div class="sourceCode" id="cb39"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>intervened_params <span class="op">=</span> [<span class="st">&quot;beta_c&quot;</span>, <span class="st">&quot;gamma&quot;</span>, <span class="st">&quot;gamma_c&quot;</span>]</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>static_parameter_interventions1 <span class="op">=</span> param_value_objective(</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    param_name<span class="op">=</span>[intervened_params[<span class="dv">0</span>]],</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    start_time<span class="op">=</span>[torch.tensor(<span class="fl">10.0</span>)],</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>static_parameter_interventions2 <span class="op">=</span> start_time_objective(</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    param_name<span class="op">=</span>[intervened_params[<span class="dv">1</span>]],</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    param_value<span class="op">=</span>[torch.tensor([<span class="fl">0.4</span>])],</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine different intervention templates</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>static_parameter_interventions_comb <span class="op">=</span> intervention_func_combinator(</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>    [static_parameter_interventions1, static_parameter_interventions2],</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>    [<span class="dv">1</span>, <span class="dv">1</span>],</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>    static_parameter_interventions1(torch.tensor(<span class="fl">0.4</span>)),</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>    static_parameter_interventions2(torch.tensor(<span class="fl">5.0</span>)),</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(static_parameter_interventions_comb(torch.tensor([<span class="fl">0.3</span>, <span class="fl">5.0</span>])))</span></code></pre></div>
<div class="output stream stdout">
<pre><code>{10.0: {&#39;beta_c&#39;: tensor([0.4000])}} {5.0: {&#39;gamma&#39;: tensor([0.4000])}}
{10.0: {&#39;beta_c&#39;: tensor([0.3000])}, 5.0: {&#39;gamma&#39;: tensor([0.4000])}}
</code></pre>
</div>
</div>
<div class="cell code" data-execution_count="23">
<div class="sourceCode" id="cb41"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define optimization problem setup</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>observed_params <span class="op">=</span> [<span class="st">&quot;I_state&quot;</span>]</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>risk_bound <span class="op">=</span> <span class="fl">3e5</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>qoi <span class="op">=</span> <span class="kw">lambda</span> y: obs_max_qoi(y, observed_params)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>initial_guess_interventions <span class="op">=</span> [<span class="fl">0.35</span>, <span class="fl">5.0</span>]</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>bounds_interventions <span class="op">=</span> [[<span class="fl">0.1</span>, <span class="fl">1.0</span>], [<span class="fl">0.5</span>, end_time_SEIRHD2]]</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Objective function</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>beta_c_current <span class="op">=</span> <span class="fl">0.35</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Scaling factors for start time and parameter values in the objective function</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>scaling_factor_obj <span class="op">=</span> [<span class="fl">1.0</span>, <span class="fl">0.4</span> <span class="op">/</span> (end_time_SEIRHD2 <span class="op">-</span> start_time)]</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>objfun <span class="op">=</span> (</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: np.<span class="bu">abs</span>(beta_c_current <span class="op">-</span> x[<span class="dv">0</span>]) <span class="op">*</span> scaling_factor_obj[<span class="dv">0</span>]</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">-</span> x[<span class="dv">1</span>] <span class="op">*</span> scaling_factor_obj[<span class="dv">1</span>]</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating a combined intervention</span></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>intervened_params <span class="op">=</span> [<span class="st">&quot;beta_c&quot;</span>, <span class="st">&quot;gamma&quot;</span>]</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>static_parameter_interventions1 <span class="op">=</span> param_value_objective(</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>    param_name<span class="op">=</span>[intervened_params[<span class="dv">0</span>]],</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>    start_time<span class="op">=</span>[torch.tensor(<span class="fl">10.0</span>)],</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>static_parameter_interventions2 <span class="op">=</span> start_time_objective(</span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>    param_name<span class="op">=</span>[intervened_params[<span class="dv">1</span>]],</span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>    param_value<span class="op">=</span>[torch.tensor([<span class="fl">0.45</span>])],</span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine different intervention templates into a list of Callables</span></span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>static_parameter_interventions <span class="op">=</span> intervention_func_combinator(</span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>    [static_parameter_interventions1, static_parameter_interventions2],</span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>    [<span class="dv">1</span>, <span class="dv">1</span>],</span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Fixed intervention on hosp parameter</span></span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a>fixed_interventions <span class="op">=</span> {<span class="fl">10.0</span>: {<span class="st">&quot;hosp&quot;</span>: torch.tensor(<span class="fl">0.1</span>)}}</span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Run optimize interface</span></span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a>opt_result6 <span class="op">=</span> pyciemss.optimize(</span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a>    model_opt2,</span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a>    end_time_SEIRHD2,</span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a>    logging_step_size,</span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a>    qoi,</span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a>    risk_bound,</span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a>    static_parameter_interventions,</span>
<span id="cb41-44"><a href="#cb41-44" aria-hidden="true" tabindex="-1"></a>    objfun,</span>
<span id="cb41-45"><a href="#cb41-45" aria-hidden="true" tabindex="-1"></a>    initial_guess_interventions<span class="op">=</span>initial_guess_interventions,</span>
<span id="cb41-46"><a href="#cb41-46" aria-hidden="true" tabindex="-1"></a>    bounds_interventions<span class="op">=</span>bounds_interventions,</span>
<span id="cb41-47"><a href="#cb41-47" aria-hidden="true" tabindex="-1"></a>    start_time<span class="op">=</span>start_time,</span>
<span id="cb41-48"><a href="#cb41-48" aria-hidden="true" tabindex="-1"></a>    n_samples_ouu<span class="op">=</span>num_samples_ouu,</span>
<span id="cb41-49"><a href="#cb41-49" aria-hidden="true" tabindex="-1"></a>    maxiter<span class="op">=</span>maxiter,</span>
<span id="cb41-50"><a href="#cb41-50" aria-hidden="true" tabindex="-1"></a>    maxfeval<span class="op">=</span>maxfeval,</span>
<span id="cb41-51"><a href="#cb41-51" aria-hidden="true" tabindex="-1"></a>    fixed_static_parameter_interventions<span class="op">=</span>fixed_interventions,</span>
<span id="cb41-52"><a href="#cb41-52" aria-hidden="true" tabindex="-1"></a>    solver_method<span class="op">=</span><span class="st">&quot;rk4&quot;</span>,</span>
<span id="cb41-53"><a href="#cb41-53" aria-hidden="true" tabindex="-1"></a>    solver_options<span class="op">=</span>{<span class="st">&quot;step_size&quot;</span>: <span class="fl">1.0</span>},</span>
<span id="cb41-54"><a href="#cb41-54" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-55"><a href="#cb41-55" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Optimal policy:&quot;</span>, opt_result6[<span class="st">&quot;policy&quot;</span>])</span>
<span id="cb41-56"><a href="#cb41-56" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(opt_result6)</span></code></pre></div>
<div class="output stream stderr">
<pre><code>  1%|          | 1/120 [00:07&lt;14:21,  7.24s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
  2%|▎         | 3/120 [00:11&lt;06:28,  3.32s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
  5%|▌         | 6/120 [00:15&lt;03:58,  2.10s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 15%|█▌        | 18/120 [00:55&lt;07:08,  4.20s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 21%|██        | 25/120 [01:19&lt;06:10,  3.90s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 27%|██▋       | 32/120 [01:43&lt;05:23,  3.67s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 28%|██▊       | 34/120 [01:47&lt;04:19,  3.02s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 39%|███▉      | 47/120 [01:51&lt;01:05,  1.12it/s]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 42%|████▏     | 50/120 [01:54&lt;01:08,  1.03it/s]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 43%|████▎     | 52/120 [01:58&lt;01:16,  1.13s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 46%|████▌     | 55/120 [02:02&lt;01:15,  1.17s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 48%|████▊     | 58/120 [02:06&lt;01:14,  1.20s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 52%|█████▎    | 63/120 [02:13&lt;01:14,  1.31s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 54%|█████▍    | 65/120 [02:17&lt;01:18,  1.42s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 78%|███████▊  | 94/120 [03:38&lt;01:52,  4.32s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 80%|████████  | 96/120 [03:42&lt;01:24,  3.50s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 87%|████████▋ | 104/120 [03:47&lt;00:23,  1.45s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 92%|█████████▏| 110/120 [03:51&lt;00:11,  1.11s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 96%|█████████▌| 115/120 [03:58&lt;00:06,  1.33s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
121it [04:02,  1.04s/it]                         C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
124it [04:02,  1.96s/it]</code></pre>
</div>
<div class="output stream stdout">
<pre><code>Optimal policy: tensor([ 0.1998, 12.1812], dtype=torch.float64)
{&#39;policy&#39;: tensor([ 0.1998, 12.1812], dtype=torch.float64), &#39;OptResults&#39;:                     message: [&#39;requested number of basinhopping iterations completed successfully&#39;]
                    success: False
                        fun: 0.09606939020723225
                          x: [ 1.998e-01  1.218e+01]
                        nit: 3
      minimization_failures: 4
                       nfev: 120
 lowest_optimization_result: message: Did not converge to a solution satisfying the constraints. See `maxcv` for magnitude of violation.
                             success: False
                              status: 4
                                 fun: 0.09606939020723225
                                   x: [ 1.998e-01  1.218e+01]
                                nfev: 30
                               maxcv: 1949.409374999872}
</code></pre>
</div>
<div class="output stream stderr">
<pre><code>
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\interfaces.py:978: UserWarning: Optimal intervention policy does not satisfy constraints.Check if the risk_bounds value is appropriate for given problem.Otherwise, try (i) different initial_guess_interventions, (ii) increasing maxiter/maxfeval,and/or (iii) increase n_samples_ouu to improve accuracy of Monte Carlo risk estimation. 
  warnings.warn(
</code></pre>
</div>
</div>
<section id="sample-using-optimal-policy-as-intervention"
class="cell markdown">
<h4>Sample using optimal policy as intervention</h4>
</section>
<div class="cell code" data-execution_count="24">
<div class="sourceCode" id="cb45"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Fixed interventions: &quot;</span>, fixed_interventions)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>intervention_list <span class="op">=</span> [deepcopy(fixed_interventions)]</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>intervention_list.extend([static_parameter_interventions(opt_result6[<span class="st">&quot;policy&quot;</span>])])</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>opt_intervention <span class="op">=</span> combine_static_parameter_interventions(intervention_list)</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Optimal intervention (including fixed interventions): &quot;</span>, opt_intervention)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pyro.poutine.seed(rng_seed<span class="op">=</span><span class="dv">0</span>):</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    result6 <span class="op">=</span> pyciemss.sample(</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>        model_opt2,</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>        end_time_SEIRHD2,</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>        logging_step_size,</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>        num_samples,</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>        start_time<span class="op">=</span>start_time,</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>        static_parameter_interventions<span class="op">=</span>opt_intervention,</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>        solver_method<span class="op">=</span><span class="st">&quot;rk4&quot;</span>,</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>        solver_options<span class="op">=</span>{<span class="st">&quot;step_size&quot;</span>: <span class="fl">1.</span>},</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Check risk estimate used in constraints</span></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Risk associated with QoI:&quot;</span>, result6[<span class="st">&quot;risk&quot;</span>][observed_params[<span class="dv">0</span>]][<span class="st">&quot;risk&quot;</span>])</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot results for all states</span></span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>schema <span class="op">=</span> plots.trajectories(result6[<span class="st">&quot;data&quot;</span>], keep<span class="op">=</span><span class="st">&quot;I_state&quot;</span>, qlow<span class="op">=</span><span class="fl">0.0</span>, qhigh<span class="op">=</span><span class="fl">1.0</span>)</span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>plots.ipy_display(schema, dpi<span class="op">=</span><span class="dv">150</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Fixed interventions:  {10.0: {&#39;hosp&#39;: tensor(0.1000)}}
Optimal intervention (including fixed interventions):  {10.0: {&#39;hosp&#39;: tensor(0.1000), &#39;beta_c&#39;: tensor([0.1998])}, 12.1812: {&#39;gamma&#39;: tensor([0.4500])}}
Risk associated with QoI: [308213.24624999985]
</code></pre>
</div>
<div class="output execute_result" data-execution_count="24">
<p><img
src="vertopal_ed73d86613e540ab84c49649ae65c317/171d13738b69bab213bd9f8ba83d686cde873bed.png" /></p>
</div>
</div>
<section id="optimize-interface-with-multiple-constraints"
class="cell markdown">
<h2>Optimize interface with multiple constraints</h2>
<h3
id="optimizing-multiple-intervention-values-andor-start-times-with-multiple-constraints-for-different-qois-with-existing-intervention-on-hosp-parameter-seirhd">Optimizing
multiple intervention values and/or start times with multiple
constraints for different QoIs with existing intervention on hosp
parameter (SEIRHD)</h3>
<p>Get infections below 300,000 individuals (risk level 95%) and
hospitalization below 100,000 individuals (risk level 90%) betweeen 0-90
days for SEIRHD model</p>
<ul>
<li>Minimum change from their current value when intervening on beta_c
after 10 days</li>
<li>Maximum delay in starting the interventions on gamma with
intervention value set to 0.35</li>
</ul>
<p>Intervention on "hosp" parameter is set to 0.1 after 10 days.</p>
<p>QoI defined as max over range of simulated time.</p>
</section>
<div class="cell code" data-execution_count="25">
<div class="sourceCode" id="cb47"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define optimization problem setup</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>observed_params <span class="op">=</span> [[<span class="st">&quot;I_state&quot;</span>], [<span class="st">&quot;H_state&quot;</span>]]</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>risk_bound <span class="op">=</span> [<span class="fl">3e5</span>, <span class="fl">1e5</span>]</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>alpha <span class="op">=</span> [<span class="fl">0.95</span>, <span class="fl">0.90</span>]</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>qoi <span class="op">=</span> [<span class="kw">lambda</span> y: obs_max_qoi(y, observed_params[<span class="dv">0</span>]), <span class="kw">lambda</span> y: obs_max_qoi(y, observed_params[<span class="dv">1</span>])]</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>initial_guess_interventions <span class="op">=</span> [<span class="fl">0.35</span>, <span class="fl">5.0</span>]</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>bounds_interventions <span class="op">=</span> [[<span class="fl">0.1</span>, <span class="fl">1.0</span>], [<span class="fl">0.5</span>, end_time_SEIRHD2]]</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Objective function</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>beta_c_current <span class="op">=</span> <span class="fl">0.35</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Scaling factors for start time and parameter values in the objective function</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>scaling_factor_obj <span class="op">=</span> [<span class="fl">1.0</span>, <span class="fl">0.4</span> <span class="op">/</span> (end_time_SEIRHD2 <span class="op">-</span> start_time)]</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>objfun <span class="op">=</span> (</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: np.<span class="bu">abs</span>(beta_c_current <span class="op">-</span> x[<span class="dv">0</span>]) <span class="op">*</span> scaling_factor_obj[<span class="dv">0</span>]</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">-</span> x[<span class="dv">1</span>] <span class="op">*</span> scaling_factor_obj[<span class="dv">1</span>]</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating a combined intervention</span></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>intervened_params <span class="op">=</span> [<span class="st">&quot;beta_c&quot;</span>, <span class="st">&quot;gamma&quot;</span>]</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>static_parameter_interventions1 <span class="op">=</span> param_value_objective(</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>    param_name<span class="op">=</span>[intervened_params[<span class="dv">0</span>]],</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>    start_time<span class="op">=</span>[torch.tensor(<span class="fl">10.0</span>)],</span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>static_parameter_interventions2 <span class="op">=</span> start_time_objective(</span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a>    param_name<span class="op">=</span>[intervened_params[<span class="dv">1</span>]],</span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a>    param_value<span class="op">=</span>[torch.tensor([<span class="fl">0.45</span>])],</span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine different intervention templates into a list of Callables</span></span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a>static_parameter_interventions <span class="op">=</span> intervention_func_combinator(</span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a>    [static_parameter_interventions1, static_parameter_interventions2],</span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a>    [<span class="dv">1</span>, <span class="dv">1</span>],</span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-34"><a href="#cb47-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Fixed intervention on hosp parameter</span></span>
<span id="cb47-35"><a href="#cb47-35" aria-hidden="true" tabindex="-1"></a>fixed_interventions <span class="op">=</span> {<span class="fl">10.0</span>: {<span class="st">&quot;hosp&quot;</span>: torch.tensor(<span class="fl">0.1</span>)}}</span>
<span id="cb47-36"><a href="#cb47-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-37"><a href="#cb47-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Run optimize interface</span></span>
<span id="cb47-38"><a href="#cb47-38" aria-hidden="true" tabindex="-1"></a>opt_result6 <span class="op">=</span> pyciemss.optimize(</span>
<span id="cb47-39"><a href="#cb47-39" aria-hidden="true" tabindex="-1"></a>    model_opt2,</span>
<span id="cb47-40"><a href="#cb47-40" aria-hidden="true" tabindex="-1"></a>    end_time_SEIRHD2,</span>
<span id="cb47-41"><a href="#cb47-41" aria-hidden="true" tabindex="-1"></a>    logging_step_size,</span>
<span id="cb47-42"><a href="#cb47-42" aria-hidden="true" tabindex="-1"></a>    qoi,</span>
<span id="cb47-43"><a href="#cb47-43" aria-hidden="true" tabindex="-1"></a>    risk_bound,</span>
<span id="cb47-44"><a href="#cb47-44" aria-hidden="true" tabindex="-1"></a>    static_parameter_interventions,</span>
<span id="cb47-45"><a href="#cb47-45" aria-hidden="true" tabindex="-1"></a>    objfun,</span>
<span id="cb47-46"><a href="#cb47-46" aria-hidden="true" tabindex="-1"></a>    initial_guess_interventions<span class="op">=</span>initial_guess_interventions,</span>
<span id="cb47-47"><a href="#cb47-47" aria-hidden="true" tabindex="-1"></a>    bounds_interventions<span class="op">=</span>bounds_interventions,</span>
<span id="cb47-48"><a href="#cb47-48" aria-hidden="true" tabindex="-1"></a>    start_time<span class="op">=</span>start_time,</span>
<span id="cb47-49"><a href="#cb47-49" aria-hidden="true" tabindex="-1"></a>    n_samples_ouu<span class="op">=</span>num_samples_ouu,</span>
<span id="cb47-50"><a href="#cb47-50" aria-hidden="true" tabindex="-1"></a>    maxiter<span class="op">=</span>maxiter,</span>
<span id="cb47-51"><a href="#cb47-51" aria-hidden="true" tabindex="-1"></a>    maxfeval<span class="op">=</span>maxfeval,</span>
<span id="cb47-52"><a href="#cb47-52" aria-hidden="true" tabindex="-1"></a>    fixed_static_parameter_interventions<span class="op">=</span>fixed_interventions,</span>
<span id="cb47-53"><a href="#cb47-53" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span>alpha,</span>
<span id="cb47-54"><a href="#cb47-54" aria-hidden="true" tabindex="-1"></a>    solver_method<span class="op">=</span><span class="st">&quot;rk4&quot;</span>,</span>
<span id="cb47-55"><a href="#cb47-55" aria-hidden="true" tabindex="-1"></a>    solver_options<span class="op">=</span>{<span class="st">&quot;step_size&quot;</span>: <span class="fl">1.0</span>},</span>
<span id="cb47-56"><a href="#cb47-56" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-57"><a href="#cb47-57" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Optimal policy:&quot;</span>, opt_result6[<span class="st">&quot;policy&quot;</span>])</span>
<span id="cb47-58"><a href="#cb47-58" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(opt_result6)</span></code></pre></div>
<div class="output stream stderr">
<pre><code>  1%|          | 1/120 [00:07&lt;15:18,  7.72s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
  2%|▎         | 3/120 [00:12&lt;07:01,  3.61s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 27%|██▋       | 32/120 [02:01&lt;05:50,  3.98s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 28%|██▊       | 34/120 [02:05&lt;04:36,  3.21s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 30%|███       | 36/120 [02:09&lt;03:53,  2.78s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 48%|████▊     | 57/120 [03:07&lt;04:09,  3.95s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 52%|█████▎    | 63/120 [03:28&lt;03:34,  3.76s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 54%|█████▍    | 65/120 [03:32&lt;02:49,  3.08s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 78%|███████▊  | 94/120 [05:00&lt;01:42,  3.93s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 80%|████████  | 96/120 [05:06&lt;01:27,  3.63s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 88%|████████▊ | 105/120 [05:11&lt;00:20,  1.40s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
 89%|████████▉ | 107/120 [05:15&lt;00:19,  1.53s/it]C:\Users\Anirban\Documents\GitHub\pyciemss\pyciemss\ouu\ouu.py:106: UserWarning: Selected interventions are out of bounds. Will use a penalty instead of estimating risk.
  warnings.warn(
124it [06:19,  3.06s/it]                         </code></pre>
</div>
<div class="output stream stdout">
<pre><code>Optimal policy: tensor([ 0.3500, 13.9001], dtype=torch.float64)
{&#39;policy&#39;: tensor([ 0.3500, 13.9001], dtype=torch.float64), &#39;OptResults&#39;:                     message: [&#39;requested number of basinhopping iterations completed successfully&#39;]
                    success: False
                        fun: -0.06177817727638459
                          x: [ 3.500e-01  1.390e+01]
                        nit: 3
      minimization_failures: 4
                       nfev: 120
 lowest_optimization_result: message: Maximum number of function evaluations has been exceeded.
                             success: False
                              status: 2
                                 fun: -0.06177817727638459
                                   x: [ 3.500e-01  1.390e+01]
                                nfev: 30
                               maxcv: 0.0}
</code></pre>
</div>
<div class="output stream stderr">
<pre><code>
</code></pre>
</div>
</div>
<section id="sample-using-optimal-policy-as-intervention"
class="cell markdown">
<h4>Sample using optimal policy as intervention</h4>
</section>
<div class="cell code" data-execution_count="26">
<div class="sourceCode" id="cb51"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Fixed interventions: &quot;</span>, fixed_interventions)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>intervention_list <span class="op">=</span> [deepcopy(fixed_interventions)]</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>intervention_list.extend([static_parameter_interventions(opt_result6[<span class="st">&quot;policy&quot;</span>])])</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>opt_intervention <span class="op">=</span> combine_static_parameter_interventions(intervention_list)</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Optimal intervention (including fixed interventions): &quot;</span>, opt_intervention)</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pyro.poutine.seed(rng_seed<span class="op">=</span><span class="dv">0</span>):</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>    result6 <span class="op">=</span> pyciemss.sample(</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>        model_opt2,</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>        end_time_SEIRHD2,</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>        logging_step_size,</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>        num_samples,</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>        start_time<span class="op">=</span>start_time,</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>        static_parameter_interventions<span class="op">=</span>opt_intervention,</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>        solver_method<span class="op">=</span><span class="st">&quot;rk4&quot;</span>,</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>        solver_options<span class="op">=</span>{<span class="st">&quot;step_size&quot;</span>: <span class="fl">1.</span>},</span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Check risk estimate used in constraints</span></span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Risk associated with QoI&quot;</span>, observed_params[<span class="dv">0</span>][<span class="dv">0</span>], result6[<span class="st">&quot;risk&quot;</span>][observed_params[<span class="dv">0</span>][<span class="dv">0</span>]][<span class="st">&quot;risk&quot;</span>])</span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Risk associated with QoI&quot;</span>, observed_params[<span class="dv">1</span>][<span class="dv">0</span>], result6[<span class="st">&quot;risk&quot;</span>][observed_params[<span class="dv">1</span>][<span class="dv">0</span>]][<span class="st">&quot;risk&quot;</span>])</span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot results for all states</span></span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a>schema <span class="op">=</span> plots.trajectories(result6[<span class="st">&quot;data&quot;</span>], keep<span class="op">=</span>[<span class="st">&quot;I_state&quot;</span>, <span class="st">&quot;H_state&quot;</span>], qlow<span class="op">=</span><span class="fl">0.0</span>, qhigh<span class="op">=</span><span class="fl">1.0</span>)</span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a>plots.ipy_display(schema, dpi<span class="op">=</span><span class="dv">150</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Fixed interventions:  {10.0: {&#39;hosp&#39;: tensor(0.1000)}}
Optimal intervention (including fixed interventions):  {10.0: {&#39;hosp&#39;: tensor(0.1000), &#39;beta_c&#39;: tensor([0.3500])}, 13.9001: {&#39;gamma&#39;: tensor([0.4500])}}
Risk associated with QoI I_state [352714.2268749998]
Risk associated with QoI H_state [61172.588671874975]
</code></pre>
</div>
<div class="output execute_result" data-execution_count="26">
<p><img
src="vertopal_ed73d86613e540ab84c49649ae65c317/8348f02bf544927f5481f99d78cb3fb74dc2c04e.png" /></p>
</div>
</div>
</body>
</html>
